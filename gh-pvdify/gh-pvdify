#!/bin/bash
# gh-pvdify - GitHub CLI extension for Pvdify
# Provides context-aware pvdify commands with GitHub repo integration

set -e

PVDIFY_BIN="${PVDIFY_BIN:-pvdify}"
PVDIFY_API="${PVDIFY_API:-https://pvdify.win}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    cat <<EOF
GitHub CLI extension for Pvdify - Heroku-style container deployments

Usage:
  gh pvdify <command> [flags]

Commands:
  deploy      Deploy current branch/commit to Pvdify
  preview     Create preview deployment for PR
  status      Show deployment status
  logs        View app logs
  rollback    Rollback to previous release
  open        Open app in browser

Examples:
  gh pvdify deploy                    # Deploy current branch
  gh pvdify deploy --app myapp        # Deploy to specific app
  gh pvdify preview                   # Create PR preview deployment
  gh pvdify status                    # Show current deployment status
  gh pvdify logs --tail               # Stream logs

Environment:
  PVDIFY_API    API URL (default: https://pvdify.win)
  PVDIFY_APP    Default app name
EOF
}

# Get GitHub repo info
get_repo_info() {
    if ! gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null; then
        echo ""
        return
    fi
}

# Get current branch
get_branch() {
    git rev-parse --abbrev-ref HEAD 2>/dev/null || echo ""
}

# Get current commit SHA
get_commit() {
    git rev-parse --short HEAD 2>/dev/null || echo ""
}

# Get app name from env, flag, or derive from repo
get_app_name() {
    local app_flag="$1"

    if [[ -n "$app_flag" ]]; then
        echo "$app_flag"
        return
    fi

    if [[ -n "$PVDIFY_APP" ]]; then
        echo "$PVDIFY_APP"
        return
    fi

    # Derive from repo name
    local repo=$(get_repo_info)
    if [[ -n "$repo" ]]; then
        echo "${repo##*/}" | tr '[:upper:]' '[:lower:]' | tr '_' '-'
        return
    fi

    # Fallback to directory name
    basename "$(pwd)" | tr '[:upper:]' '[:lower:]' | tr '_' '-'
}

# Get image from ghcr.io
get_image() {
    local repo=$(get_repo_info)
    local commit=$(get_commit)

    if [[ -z "$repo" ]]; then
        echo ""
        return
    fi

    echo "ghcr.io/${repo}:${commit:-latest}"
}

cmd_deploy() {
    local app=""
    local image=""
    local force=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --app|-a) app="$2"; shift 2 ;;
            --image|-i) image="$2"; shift 2 ;;
            --force|-f) force=true; shift ;;
            *) shift ;;
        esac
    done

    app=$(get_app_name "$app")
    if [[ -z "$image" ]]; then
        image=$(get_image)
    fi

    local branch=$(get_branch)
    local commit=$(get_commit)

    echo -e "${BLUE}Deploying to Pvdify${NC}"
    echo -e "  App:    ${GREEN}$app${NC}"
    echo -e "  Image:  ${GREEN}$image${NC}"
    echo -e "  Branch: ${YELLOW}$branch${NC}"
    echo -e "  Commit: ${YELLOW}$commit${NC}"
    echo ""

    # Check if app exists, create if not
    if ! $PVDIFY_BIN apps:info "$app" --api-url "$PVDIFY_API" &>/dev/null; then
        echo -e "${YELLOW}Creating app: $app${NC}"
        $PVDIFY_BIN apps:create "$app" --api-url "$PVDIFY_API"
    fi

    # Deploy
    $PVDIFY_BIN deploy "$app" --image "$image" --api-url "$PVDIFY_API"

    echo ""
    echo -e "${GREEN}Deployment initiated!${NC}"
    echo -e "View status: ${BLUE}gh pvdify status --app $app${NC}"
}

cmd_preview() {
    local pr_number=""

    # Try to get PR number from current branch
    if command -v gh &>/dev/null; then
        pr_number=$(gh pr view --json number -q .number 2>/dev/null || echo "")
    fi

    if [[ -z "$pr_number" ]]; then
        echo -e "${RED}Error: Not on a PR branch${NC}"
        echo "Run this command from a branch with an open PR"
        exit 1
    fi

    local repo=$(get_repo_info)
    local base_app=$(get_app_name "")
    local preview_app="${base_app}-pr-${pr_number}"
    local image=$(get_image)

    echo -e "${BLUE}Creating preview deployment${NC}"
    echo -e "  PR:     ${GREEN}#$pr_number${NC}"
    echo -e "  App:    ${GREEN}$preview_app${NC}"
    echo -e "  Image:  ${GREEN}$image${NC}"
    echo ""

    # Create preview app if needed
    if ! $PVDIFY_BIN apps:info "$preview_app" --api-url "$PVDIFY_API" &>/dev/null; then
        $PVDIFY_BIN apps:create "$preview_app" --api-url "$PVDIFY_API"
    fi

    # Deploy
    $PVDIFY_BIN deploy "$preview_app" --image "$image" --api-url "$PVDIFY_API"

    echo ""
    echo -e "${GREEN}Preview deployed!${NC}"
    echo -e "URL: ${BLUE}https://${preview_app}.pvdify.win${NC}"

    # Add PR comment
    if command -v gh &>/dev/null; then
        gh pr comment "$pr_number" --body "ðŸš€ Preview deployment ready: https://${preview_app}.pvdify.win" 2>/dev/null || true
    fi
}

cmd_status() {
    local app=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --app|-a) app="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    app=$(get_app_name "$app")

    echo -e "${BLUE}Deployment Status: $app${NC}"
    echo ""

    $PVDIFY_BIN apps:info "$app" --api-url "$PVDIFY_API"
    echo ""

    echo -e "${BLUE}Recent Releases:${NC}"
    $PVDIFY_BIN releases "$app" --api-url "$PVDIFY_API" 2>/dev/null | head -5
}

cmd_logs() {
    local app=""
    local tail=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --app|-a) app="$2"; shift 2 ;;
            --tail|-t) tail=true; shift ;;
            *) shift ;;
        esac
    done

    app=$(get_app_name "$app")

    if $tail; then
        $PVDIFY_BIN logs "$app" --tail --api-url "$PVDIFY_API"
    else
        $PVDIFY_BIN logs "$app" --api-url "$PVDIFY_API"
    fi
}

cmd_rollback() {
    local app=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --app|-a) app="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    app=$(get_app_name "$app")

    echo -e "${YELLOW}Rolling back: $app${NC}"
    $PVDIFY_BIN rollback "$app" --api-url "$PVDIFY_API"
}

cmd_open() {
    local app=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --app|-a) app="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    app=$(get_app_name "$app")
    local url="https://${app}.pvdify.win"

    echo -e "Opening ${BLUE}$url${NC}"

    if command -v xdg-open &>/dev/null; then
        xdg-open "$url"
    elif command -v open &>/dev/null; then
        open "$url"
    else
        echo "$url"
    fi
}

# Main
case "${1:-}" in
    deploy)   shift; cmd_deploy "$@" ;;
    preview)  shift; cmd_preview "$@" ;;
    status)   shift; cmd_status "$@" ;;
    logs)     shift; cmd_logs "$@" ;;
    rollback) shift; cmd_rollback "$@" ;;
    open)     shift; cmd_open "$@" ;;
    help|--help|-h|"") usage ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        usage
        exit 1
        ;;
esac
